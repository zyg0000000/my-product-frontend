<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¼å‡ºå­—æ®µè°ƒè¯•å·¥å…·</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .section {
            background: white;
            padding: 20px;
            margin: 20px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        h1 { color: #1f2937; }
        h2 { color: #4b5563; margin-top: 0; }
        .test-btn {
            background: #4f46e5;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        .test-btn:hover {
            background: #4338ca;
        }
        pre {
            background: #1f2937;
            color: #10b981;
            padding: 15px;
            border-radius: 6px;
            overflow-x: auto;
            font-size: 12px;
            line-height: 1.6;
        }
        .status {
            padding: 8px 16px;
            border-radius: 4px;
            display: inline-block;
            margin: 10px 0;
        }
        .status.success {
            background: #d1fae5;
            color: #065f46;
        }
        .status.error {
            background: #fee2e2;
            color: #991b1b;
        }
        .label {
            font-weight: bold;
            color: #6b7280;
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” å¯¼å‡ºå­—æ®µè°ƒè¯•å·¥å…·</h1>

    <div class="section">
        <h2>æ­¥éª¤ 1: æµ‹è¯•åç«¯ API è°ƒç”¨</h2>
        <p>ç›´æ¥è°ƒç”¨åç«¯ APIï¼ŒéªŒè¯ taskId å’Œ videoId æ˜¯å¦æ­£ç¡®è¿”å›</p>
        <button class="test-btn" onclick="testBackendAPI()">æµ‹è¯•åç«¯ API</button>
        <div id="backend-result"></div>
    </div>

    <div class="section">
        <h2>æ­¥éª¤ 2: æ£€æŸ¥å­—æ®µæ˜ å°„</h2>
        <p>éªŒè¯å‰ç«¯æ‰€æœ‰æ˜ å°„è¡¨æ˜¯å¦åŒ…å«æ–°å­—æ®µ</p>
        <button class="test-btn" onclick="checkMappings()">æ£€æŸ¥æ˜ å°„</button>
        <div id="mapping-result"></div>
    </div>

    <script type="module">
        window.testBackendAPI = async function() {
            const resultDiv = document.getElementById('backend-result');
            resultDiv.innerHTML = '<p class="status">æ­£åœ¨æµ‹è¯•...</p>';

            const API_URL = 'https://sd2pl0r2pkvfku8btbid0.apigateway-cn-shanghai.volceapi.com/export-comprehensive-data';

            const payload = {
                entity: 'collaboration',
                fields: [
                    'collaboration_status',
                    'collaboration_amount',
                    'taskId',
                    'videoId',
                    'nickname'
                ],
                filters: {}
            };

            try {
                console.log('ğŸ“¤ å‘é€è¯·æ±‚:', payload);

                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                });

                const data = await response.json();
                console.log('ğŸ“¥ åç«¯å“åº”:', data);

                if (data.success && data.data && data.data.length > 0) {
                    const firstRecord = data.data[0];
                    const hasTaskId = 'æ˜Ÿå›¾ä»»åŠ¡ID' in firstRecord;
                    const hasVideoId = 'è§†é¢‘ID' in firstRecord;

                    let html = `<p class="status success">âœ… API è°ƒç”¨æˆåŠŸï¼Œè¿”å› ${data.data.length} æ¡è®°å½•</p>`;
                    html += `<div class="label">ç¬¬ä¸€æ¡è®°å½•çš„å­—æ®µï¼š</div>`;
                    html += `<pre>${JSON.stringify(firstRecord, null, 2)}</pre>`;

                    html += `<div class="label">å­—æ®µæ£€æŸ¥ï¼š</div>`;
                    html += `<p style="color: ${hasTaskId ? '#10b981' : '#ef4444'}">`;
                    html += `${hasTaskId ? 'âœ…' : 'âŒ'} æ˜Ÿå›¾ä»»åŠ¡ID: ${hasTaskId ? firstRecord['æ˜Ÿå›¾ä»»åŠ¡ID'] : 'ç¼ºå¤±'}`;
                    html += `</p>`;
                    html += `<p style="color: ${hasVideoId ? '#10b981' : '#ef4444'}">`;
                    html += `${hasVideoId ? 'âœ…' : 'âŒ'} è§†é¢‘ID: ${hasVideoId ? firstRecord['è§†é¢‘ID'] : 'ç¼ºå¤±'}`;
                    html += `</p>`;

                    resultDiv.innerHTML = html;
                } else {
                    resultDiv.innerHTML = `<p class="status error">âŒ ${data.message || 'æœªè¿”å›æ•°æ®'}</p>`;
                }

            } catch (error) {
                console.error('æµ‹è¯•å¤±è´¥:', error);
                resultDiv.innerHTML = `<p class="status error">âŒ è¯·æ±‚å¤±è´¥: ${error.message}</p>`;
            }
        };

        window.checkMappings = async function() {
            const resultDiv = document.getElementById('mapping-result');

            try {
                // åŠ¨æ€å¯¼å…¥æ¨¡å—
                const { default: tablePreview } = await import('./data_export_center/table-preview.js');
                const { default: exportHandler } = await import('./data_export_center/export-handler.js');

                let html = '<div class="label">æ­£åœ¨æ£€æŸ¥æ˜ å°„...</div>';

                // æ£€æŸ¥ table-preview.js ä¸­çš„æ˜ å°„
                const tablePreviewCode = await fetch('./data_export_center/table-preview.js').then(r => r.text());
                const hasTaskIdInTable = tablePreviewCode.includes("'taskId': 'æ˜Ÿå›¾ä»»åŠ¡ID'");
                const hasVideoIdInTable = tablePreviewCode.includes("'videoId': 'è§†é¢‘ID'");

                // æ£€æŸ¥ export-handler.js ä¸­çš„æ˜ å°„
                const exportHandlerCode = await fetch('./data_export_center/export-handler.js').then(r => r.text());
                const hasTaskIdInExport = exportHandlerCode.includes("'taskId': 'æ˜Ÿå›¾ä»»åŠ¡ID'");
                const hasVideoIdInExport = exportHandlerCode.includes("'videoId': 'è§†é¢‘ID'");

                html += '<h3>table-preview.js FIELD_TO_BACKEND_KEY_MAP:</h3>';
                html += `<p style="color: ${hasTaskIdInTable ? '#10b981' : '#ef4444'}">`;
                html += `${hasTaskIdInTable ? 'âœ…' : 'âŒ'} taskId æ˜ å°„`;
                html += `</p>`;
                html += `<p style="color: ${hasVideoIdInTable ? '#10b981' : '#ef4444'}">`;
                html += `${hasVideoIdInTable ? 'âœ…' : 'âŒ'} videoId æ˜ å°„`;
                html += `</p>`;

                html += '<h3>export-handler.js BACKEND_FIELD_KEY_MAP:</h3>';
                html += `<p style="color: ${hasTaskIdInExport ? '#10b981' : '#ef4444'}">`;
                html += `${hasTaskIdInExport ? 'âœ…' : 'âŒ'} taskId æ˜ å°„`;
                html += `</p>`;
                html += `<p style="color: ${hasVideoIdInExport ? '#10b981' : '#ef4444'}">`;
                html += `${hasVideoIdInExport ? 'âœ…' : 'âŒ'} videoId æ˜ å°„`;
                html += `</p>`;

                resultDiv.innerHTML = html;

            } catch (error) {
                console.error('æ£€æŸ¥å¤±è´¥:', error);
                resultDiv.innerHTML = `<p class="status error">âŒ æ£€æŸ¥å¤±è´¥: ${error.message}</p>`;
            }
        };
    </script>
</body>
</html>
