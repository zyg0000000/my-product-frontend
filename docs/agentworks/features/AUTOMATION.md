# 自动化功能详解

> **页面文件**: `frontends/byteproject/project_automation.html`
> **优化时间**: 2025-11
> **架构**: 3-Tab 设计

---

## 📋 概述

自动化功能用于批量执行重复性任务，包括截图抓取、数据提取、飞书表格生成等。采用工作流引擎驱动，支持多种自动化场景。

## 🏗️ 架构设计

### 模块划分

```
project_automation/
├── main.js                      # 主控制器
├── tab-talents.js               # Tab 1: 发起任务
├── tab-jobs.js                  # Tab 2: 任务批次
├── tab-sheets.js                # Tab 3: 飞书表格生成
├── modal-automation.js          # 自动化配置弹窗
├── modal-sheet-generator.js     # 表格生成抽屉
└── modals.js                    # 其他弹窗
```

---

## 📋 Tab 1: 发起任务

### 功能说明

选择达人发起自动化任务，执行预定义的工作流。

### 核心功能

1. **达人选择**
   - 显示当前项目的所有合作达人
   - 支持批量选择
   - 显示达人基本信息

2. **工作流选择**
   - 从下拉列表选择工作流类型
   - 显示工作流说明
   - 预览工作流步骤

3. **任务配置**
   - 设置任务参数
   - 选择执行时间
   - 配置通知方式

4. **提交任务**
   - 创建任务批次
   - 启动自动化执行

---

## 📊 Tab 2: 任务批次

### 功能说明

查看和管理所有自动化任务批次，支持筛选和进度跟踪。

### 筛选卡片设计（性能优化）

**统计卡片展示**：
- 全部任务
- 各工作流任务数量

**快速筛选**：
- 点击卡片筛选对应工作流的任务
- 单表分页显示，避免全展开导致的性能问题

### 任务列表

**批次信息**：
- 批次 ID
- 创建时间
- 工作流类型（带类型标签）

**状态追踪**：
| 状态 | 说明 |
|------|------|
| 进行中 | 任务正在执行 |
| 已完成 | 所有子任务完成 |
| 失败 | 存在失败的子任务 |

**进度统计**：
- 成功任务数 / 总任务数
- 失败任务数
- 完成率百分比

### 操作功能

- **查看详情**：展开查看所有子任务
- **重试失败任务**：重新执行失败的子任务
- **取消任务**：停止执行中的任务

---

## 📑 Tab 3: 飞书表格生成记录

### 功能说明

根据自动化任务结果生成飞书多维表格，并记录生成历史。

### 模板-工作流关联（核心特性）

**关联配置**：
- 选择报告模板
- 模板配置 `allowedWorkflowIds` 字段
- 自动筛选允许的工作流类型

**精准控制**：
- 仅显示允许的工作流类型的已完成任务
- 避免数据源混乱
- 提高表格生成准确性

### 功能操作

1. **选择任务记录**
   - 显示已完成的任务批次
   - 根据模板配置过滤工作流类型
   - 支持多选

2. **一键生成飞书表格**
   - 选择映射模板
   - 配置表格参数
   - 生成并同步到飞书

3. **历史生成记录查看**
   - 显示所有生成记录
   - 记录生成时间、模板、任务批次
   - 表格链接快速跳转

### 技术亮点

- ✅ **Tab样式统一**：参考 `project_report` 的Tab设计，包含图标和动效
- ✅ **性能优化**：工作流筛选卡片替代全展开设计
- ✅ **配置化控制**：模板-工作流关联实现业务逻辑配置化
- ✅ **向后兼容**：未配置关联的旧模板仍可正常使用

---

## 🔧 工作流引擎

### 工作流定义

工作流由一系列步骤组成，每个步骤定义了要执行的操作。

**示例工作流**：
```javascript
{
  id: 'workflow-1',
  name: '抓取返点截图',
  steps: [
    {
      type: 'navigate',
      url: 'https://star.toutiao.com/order/{{xingtuId}}'
    },
    {
      type: 'wait',
      selector: '.order-detail',
      timeout: 5000
    },
    {
      type: 'screenshot',
      selector: '.rebate-info',
      uploadPath: 'screenshots/rebate/{{talentId}}_{{date}}.png'
    },
    {
      type: 'extract',
      selector: '.rebate-value',
      field: 'actualRebate'
    }
  ]
}
```

### 步骤类型

| 类型 | 说明 | 参数 |
|------|------|------|
| navigate | 导航到URL | url, waitUntil |
| click | 点击元素 | selector, waitAfter |
| wait | 等待元素出现 | selector, timeout |
| screenshot | 截图并上传 | selector, uploadPath |
| extract | 提取数据 | selector, field, transform |
| input | 输入文本 | selector, value |
| scroll | 滚动页面 | direction, distance |

### URL 占位符

支持以下占位符，执行时自动替换：

| 占位符 | 说明 | 示例 |
|--------|------|------|
| `{{xingtuId}}` | 星图ID | 12345678 |
| `{{taskId}}` | 任务ID | task-001 |
| `{{videoId}}` | 视频ID | v1234567890 |
| `{{talentId}}` | 达人ID | talent-001 |
| `{{date}}` | 当前日期 | 2025-11-11 |

---

## 🤖 本地爬虫代理

### 代理说明

**代码位置**: [my-local-agent](https://github.com/zyg0000000/my-local-agent)

本地部署的 Puppeteer 自动化代理，负责执行工作流中定义的截图和数据抓取任务。

### 核心功能

1. **执行工作流步骤**
   - 导航、点击、等待
   - 截图、提取数据

2. **URL 占位符替换**
   - 自动替换 `{{xingtuId}}`、`{{taskId}}` 等

3. **截图上传**
   - 上传到 TOS 对象存储
   - 返回文件URL

4. **任务状态同步**
   - 实时更新任务状态
   - 记录执行日志

### 工作流程

```
1. 前端创建任务批次
   ↓
2. 任务分发到爬虫代理
   ↓
3. 代理执行工作流步骤
   ↓
4. 截图上传到 TOS
   ↓
5. 数据提取并保存
   ↓
6. 更新任务状态
   ↓
7. 前端显示执行结果
```

---

## 📊 模板管理

### 映射模板配置

**页面文件**: `frontends/byteproject/mapping_templates.html`

### 模板配置

1. **基础信息**
   - 名称
   - 描述
   - 飞书表格Token

2. **字段映射**
   - 飞书表格列与数据字段的映射规则
   - 支持自定义转换函数

3. **工作流关联**（新增）
   - 动态加载可用工作流列表
   - 多选checkbox配置允许的工作流
   - 未选择表示允许所有工作流
   - 保存到数据库 `allowedWorkflowIds` 字段

### 后端支持

**云函数 v4.0**（mapping-templates-api）：
- 支持 `allowedWorkflowIds` 字段的存储和查询
- GET 接口返回工作流关联配置
- POST/PUT 接口支持更新工作流关联

**相关文档**：
- 📖 快速参考：`docs/api/backend-api-v4.0-README.md`
- 📝 更新日志：`docs/api/backend-api-v4.0-CHANGELOG.md`
- 🚀 部署指南：`docs/api/backend-api-v4.0-DEPLOYMENT.md`

---

## 🎯 使用场景

### 场景 1: 批量抓取返点截图

1. 打开项目自动化页面
2. 选择需要抓取截图的达人
3. 选择"抓取返点截图"工作流
4. 点击"发起任务"
5. 切换到"任务批次" Tab 查看进度
6. 等待任务完成，查看截图

### 场景 2: 生成飞书报表

1. 切换到"飞书表格生成记录" Tab
2. 选择报告模板
3. 选择已完成的任务批次（自动过滤工作流类型）
4. 点击"生成表格"
5. 查看生成记录，点击链接打开飞书表格

### 场景 3: 重试失败任务

1. 在"任务批次" Tab 找到失败的任务
2. 点击"查看详情"
3. 查看失败原因
4. 点击"重试失败任务"
5. 等待重试完成

---

## 🐛 常见问题

### Q1: 为什么任务一直在"进行中"状态？

**A**:
1. 检查本地爬虫代理是否正常运行
2. 查看代理日志，确认是否有错误
3. 检查网络连接
4. 如长时间未完成，可取消任务重新发起

### Q2: 截图上传失败怎么办？

**A**:
1. 检查 TOS 存储配置
2. 确认访问密钥是否正确
3. 查看代理日志中的详细错误信息
4. 重试任务

### Q3: 如何添加新的工作流？

**A**:
1. 在 `automation-workflows` 集合中创建新工作流
2. 定义工作流步骤和参数
3. 在前端下拉列表中会自动显示
4. 如需模板关联，更新模板配置

---

## 🔗 相关文档

- [项目日报功能](./PROJECT_REPORT.md)
- [本地爬虫代理文档](https://github.com/zyg0000000/my-local-agent)
- [云函数 API 文档](../api/API_REFERENCE.md)
- [数据库 Schema](../../database/README.md)

---

**最后更新**: 2025-11-11
**文档版本**: v1.0
