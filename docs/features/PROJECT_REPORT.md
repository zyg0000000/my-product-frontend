# 项目日报功能详解

> **页面文件**: `frontends/byteproject/project_report.html`
> **模块化架构**: 7个独立模块
> **功能更新**: 2025-11 (v2.0)

---

## 📋 概述

项目日报功能采用模块化架构，包含三个核心 Tab，用于项目数据查看、手动录入和效果监测。

## 🏗️ 架构设计

### 模块划分

```
project_report/
├── main.js                    # 主控制器
├── constants.js               # 常量定义
├── utils.js                   # 工具函数
├── tab-daily-report.js        # Tab 1: 项目日报
├── tab-data-entry.js          # Tab 2: 数据录入
├── tab-effect-monitor.js      # Tab 3: 效果监测
└── automation-manager.js      # 自动化管理
```

---

## 📊 Tab 1: 项目日报

### 功能说明

- 查看项目内所有视频的播放量数据
- 按日期筛选和展示数据
- 数据图表化展示
- 导出功能支持

### 核心功能

1. **日期筛选器**
   - 支持日期范围选择
   - 快捷日期选项（最近7天、14天、30天）

2. **数据展示**
   - 视频播放量趋势图
   - 达人效果对比表格
   - 关键指标统计

3. **数据导出**
   - 导出为 Excel 格式
   - 自定义导出字段

---

## ✍️ Tab 2: 数据录入

### 功能说明

手动录入或自动抓取视频播放量数据，支持智能表单控制和自动化抓取。

### 智能日期选择

- **可视化日期选择器**
- **快捷按钮**：今天 / 昨天 / 前天
- **自动加载**：对应日期的视频列表

### 实时统计面板

| 统计项 | 说明 |
|--------|------|
| 共 X 条视频 | 当前项目视频总数 |
| ✅ 已发布 X | 有发布日期的视频数 |
| ⏳ 待发布 X | 无发布日期的视频数 |

### 视频列表展示

| 列名 | 宽度 | 说明 |
|------|------|------|
| 达人名称 | 15% | 合作达人昵称 |
| 任务 ID | 15% | 星图任务编号 |
| 发布时间 | 12% | 视频发布日期 |
| 视频链接 | 20% | 抖音视频 ID（可点击跳转） |
| 当日累计总播放 | 25% | 播放量输入框 |
| 状态 | 13% | 视频状态（动态显示） |

### 智能状态显示

| 状态 | 说明 |
|------|------|
| ⏰ 已发布X天 | 视频已发布且未超14天 |
| ⚠️ 超14天 | 视频发布超过14天 |
| 🟡 排队中... | 自动抓取任务在队列中 |
| 🔵 自动抓取中... | 正在执行自动抓取 |
| ✅ 已完成 | 自动抓取成功 |
| ❌ 失败 | 自动抓取失败（可重试） |
| - | 未发布视频 |

### 智能输入控制

- ✅ **已发布视频**：输入框可用，可手动录入或自动抓取
- 🚫 **未发布视频**：输入框禁用（灰色背景），placeholder 显示"未发布，不可录入"

### 自动化数据抓取

| 功能 | 说明 |
|------|------|
| 一键抓取 (≤14天) | 批量抓取14天内发布的视频数据 |
| 一键抓取 (>14天) | 批量抓取超过14天的视频数据（需特殊权限） |
| 待手动更新 | 标记为待手动更新的视频 |

### 数据保存

- 仅保存已发布视频的数据
- 保存后自动切换到"项目日报" Tab
- 数据实时同步到 MongoDB
- 支持批量保存

---

## 📈 Tab 3: 效果监测

### 功能说明

查看和分析项目内达人的效果数据，包括播放量趋势、CPM 分析等。

### 模块化升级

- **完全重写**: `tab-effect-monitor.js`（40行 → 834行）
- **前端聚合**: 多日数据聚合，无需新增后端 API
- **Chart.js 可视化**: 达人效果趋势图表
- **预留接口**: 历史对比功能

### 日期范围选择（默认14天）

- 🔵 **快捷选项**：最近7天 / 最近14天 / 最近30天 / 全部
- 📅 **自定义日期**：从项目第一个发布日到今天
- ⚡ **智能起始日期**：自动查找项目内最早的视频发布日期

### 左侧达人列表（1/3宽度）

**实时搜索**：
- 按达人名称过滤

**6种排序方式**：
- 总播放量 ↓ / ↑
- 平均CPM ↓ / ↑
- 最新播放 ↓
- 增长率 ↓

**达人卡片**：
- 显示播放量、CPM、增长率、合作天数
- ✨ 选中高亮（蓝色边框）

### 右侧达人详情（2/3宽度）

**关键指标卡片**（4个）：
- 总播放量（蓝色）
- 平均CPM（紫色）
- 合作天数（绿色）
- 视频数量（橙色）

**双趋势图可视化**（Chart.js）：
- 累积播放量趋势图（蓝色折线，填充渐变）
- CPM 趋势图（紫色折线，填充渐变）
- 支持悬停查看详细数据
- 响应式设计，自适应容器大小

**每日数据明细表**：
- 完整的日期 - 播放量 - CPM 列表
- 支持滚动查看全部数据

**历史对比占位**：
- 虚线边框提示区域
- 预留接口 `fetchTalentHistory()`、`renderHistoryComparison()`
- 未来支持与历史项目对比

### 技术亮点

- ✅ **前端数据聚合**：调用现有 `/project-report` 接口，按日期范围批量获取
- ✅ **按达人分组**：自动聚合同一达人在不同日期的数据
- ✅ **性能优化**：Chart.js 图表自动销毁，避免内存泄漏
- ✅ **状态管理**：独立的搜索、排序、日期范围状态
- ✅ **无外部依赖**：复用 `AppCore`（API、Format）和 `ReportUtils`

---

## 🔧 技术实现

### API 调用

**云函数**: `handleProjectReport`

**主要接口**：
1. `getVideosForEntry` - 获取数据录入视频列表
2. `saveDailyStats` - 保存每日播放量数据
3. `getProjectReport` - 获取项目日报数据

### 数据流

```
1. 用户选择日期
   ↓
2. 前端调用 getVideosForEntry
   ↓
3. 显示视频列表（已发布/待发布）
   ↓
4. 用户录入或自动抓取数据
   ↓
5. 调用 saveDailyStats 保存
   ↓
6. MongoDB 存储 (project_daily_stats 集合)
```

### 自动化抓取流程

```
1. 用户点击"一键抓取"
   ↓
2. 创建自动化任务批次
   ↓
3. 本地爬虫代理执行抓取
   ↓
4. 上传截图到 TOS
   ↓
5. 提取播放量数据
   ↓
6. 自动保存到数据库
```

---

## 📝 使用场景

### 场景 1: 每日数据录入

1. 打开项目日报页面
2. 切换到"数据录入" Tab
3. 选择日期（默认今天）
4. 查看已发布视频列表
5. 手动输入播放量或点击"一键抓取"
6. 点击"保存数据"

### 场景 2: 查看效果监测

1. 切换到"效果监测" Tab
2. 选择日期范围（默认最近14天）
3. 浏览达人列表，点击查看详情
4. 查看播放量趋势图和 CPM 分析
5. 导出数据报表

### 场景 3: 历史数据查询

1. 切换到"项目日报" Tab
2. 选择日期范围
3. 查看数据图表和统计
4. 导出为 Excel

---

## 🐛 常见问题

### Q1: 为什么有些视频输入框不可用？

**A**: 只有已发布的视频才能录入数据。未发布视频的输入框会被禁用，并显示"未发布，不可录入"。

### Q2: 自动抓取失败怎么办？

**A**:
1. 检查视频是否已发布
2. 确认视频链接是否正确
3. 查看自动化任务日志
4. 可以手动录入数据作为备选

### Q3: 如何修改已保存的数据？

**A**:
1. 选择对应日期
2. 重新输入正确的播放量
3. 点击"保存数据"覆盖旧数据

---

## 🔗 相关文档

- [自动化功能详解](./AUTOMATION.md)
- [云函数 API 文档](../api/API_REFERENCE.md)
- [数据库 Schema](../../database/README.md)

---

**最后更新**: 2025-11-11
**文档版本**: v1.0
