{
    "collection": "rebate_configs",
    "description": "返点配置历史记录集合 - 记录所有返点调整操作的完整审计追溯",
    "database": "agentworks_db",
    "version": "2.2",
    "lastUpdated": "2025-12-14",
    "author": "产品团队",
    "fields": {
        "_id": {
            "type": "ObjectId",
            "description": "MongoDB 文档 ID",
            "required": true,
            "auto": true
        },
        "configId": {
            "type": "String",
            "description": "配置唯一标识",
            "required": true,
            "pattern": "^rebate_config_[0-9]{13}_[a-z0-9]{6}$",
            "example": "rebate_config_1737024000000_abc123",
            "comment": "格式：rebate_config_{timestamp}_{random6}"
        },
        "targetType": {
            "type": "String",
            "description": "目标类型",
            "required": true,
            "enum": ["talent", "agency", "customer_talent"],
            "default": "talent",
            "comment": "talent=达人返点, agency=机构返点, customer_talent=客户级返点（v2.2新增）"
        },
        "targetId": {
            "type": "String",
            "description": "目标ID",
            "required": true,
            "example": "talent_00000005",
            "comment": "talent→oneId, agency→agencyId, customer_talent→{customerId}_{talentOneId}_{platform}"
        },
        "customerId": {
            "type": "String",
            "description": "客户编码（仅 targetType='customer_talent' 时使用）",
            "required": false,
            "pattern": "^CUS[0-9]{8}$",
            "example": "CUS20250001",
            "comment": "v2.2新增，用于客户级返点历史记录",
            "addedIn": "v2.2 (2025-12-14)"
        },
        "talentOneId": {
            "type": "String",
            "description": "达人统一ID（仅 targetType='customer_talent' 时使用）",
            "required": false,
            "pattern": "^talent_[0-9]{8}$",
            "example": "talent_00000005",
            "comment": "v2.2新增，用于客户级返点历史记录",
            "addedIn": "v2.2 (2025-12-14)"
        },
        "previousRate": {
            "type": "Double",
            "description": "调整前返点率",
            "required": false,
            "min": 0,
            "max": 100,
            "example": 20.00,
            "comment": "v2.2新增，记录调整前的返点率，便于对比分析",
            "addedIn": "v2.2 (2025-12-14)"
        },
        "platform": {
            "type": "String",
            "description": "平台类型",
            "required": true,
            "enum": ["douyin", "xiaohongshu", "bilibili", "kuaishou"],
            "comment": "与 talents 集合的 platform 字段对应"
        },
        "rebateRate": {
            "type": "Double",
            "description": "返点率（百分比，2位小数）",
            "required": true,
            "min": 0,
            "max": 100,
            "example": 22.50,
            "comment": "精度：小数点后2位，范围0-100"
        },
        "effectType": {
            "type": "String",
            "description": "生效方式",
            "required": true,
            "enum": ["immediate", "next_cooperation"],
            "comment": "immediate=立即生效, next_cooperation=下次合作生效"
        },
        "effectiveDate": {
            "type": "Date",
            "description": "生效时间（ISO 8601 时间戳）",
            "required": true,
            "example": "2025-01-15T10:30:00.000Z",
            "comment": "返点开始生效的精确时间，使用 ISO 8601 格式"
        },
        "expiryDate": {
            "type": "Date",
            "description": "失效时间（ISO 8601 时间戳）",
            "required": false,
            "default": null,
            "example": "2025-01-15T14:20:00.000Z",
            "comment": "null 表示当前生效中，被新配置替代时自动设置为新配置的 effectiveDate"
        },
        "status": {
            "type": "String",
            "description": "配置状态",
            "required": true,
            "enum": ["pending", "active", "expired"],
            "default": "active",
            "comment": "pending=待生效, active=已生效（当前使用）, expired=已失效（被替代）"
        },
        "reason": {
            "type": "String",
            "description": "调整原因",
            "required": false,
            "maxLength": 500,
            "example": "合作表现优秀，提升返点",
            "comment": "记录为什么调整返点，便于后期追溯"
        },
        "createdBy": {
            "type": "String",
            "description": "操作人",
            "required": true,
            "default": "system",
            "example": "admin_user_id",
            "comment": "记录是谁创建的这条配置"
        },
        "createdAt": {
            "type": "Date",
            "description": "创建时间（ISO 8601）",
            "required": true,
            "default": "now",
            "example": "2025-01-15T10:30:00.000Z"
        },
        "updatedAt": {
            "type": "Date",
            "description": "更新时间（ISO 8601）",
            "required": false,
            "example": "2025-01-15T10:30:00.000Z",
            "comment": "记录状态变更时间（如从 active 变为 expired）"
        }
    },
    "indexes": [
        {
            "name": "idx_configId",
            "fields": { "configId": 1 },
            "unique": true,
            "description": "配置ID唯一索引"
        },
        {
            "name": "idx_target_platform_createdAt",
            "fields": { "targetId": 1, "platform": 1, "createdAt": -1 },
            "description": "查询某达人某平台的返点历史（按时间倒序）"
        },
        {
            "name": "idx_status",
            "fields": { "status": 1 },
            "description": "按状态查询"
        },
        {
            "name": "idx_effectiveDate",
            "fields": { "effectiveDate": 1 },
            "description": "按生效日期查询"
        },
        {
            "name": "idx_createdBy",
            "fields": { "createdBy": 1 },
            "description": "查询某操作人的所有配置记录"
        },
        {
            "name": "idx_customer_talent_history",
            "fields": { "targetType": 1, "customerId": 1, "talentOneId": 1, "platform": 1, "createdAt": -1 },
            "description": "查询客户级返点历史（v2.2新增）"
        },
        {
            "name": "idx_talent_all_customers",
            "fields": { "talentOneId": 1, "targetType": 1, "createdAt": -1 },
            "description": "查询某达人在所有客户的返点历史（v2.2新增）"
        }
    ],
    "relations": [
        {
            "collection": "talents",
            "type": "many-to-one",
            "foreignKey": "targetId",
            "description": "多条返点配置对应一个达人（通过 oneId）"
        }
    ],
    "notes": [
        "【设计目的】独立存储返点配置历史，支持完整的审计追溯",
        "【不可变性】所有记录一旦创建不可删除，只能标记为 expired",
        "【状态流转】pending → active → expired",
        "【立即生效】effectType='immediate' 时，自动将旧 active 配置标记为 expired 并设置 expiryDate，然后创建新 active 记录并更新 talents.currentRebate",
        "【下次生效】effectType='next_cooperation' 时，创建 pending 记录，等待合作时激活",
        "【自动管理】创建新 active 配置时，旧 active 配置自动标记为 expired，expiryDate 设置为新配置的 effectiveDate",
        "【唯一约束】configId 全局唯一",
        "【查询优化】targetId + platform + createdAt 复合索引，支持高效的历史查询",
        "【数据完整性】永久保留所有记录，不允许删除",
        "【时间精度】createdAt 使用 ISO 8601 格式，精确到毫秒",
        "【返点精度】rebateRate 保留2位小数，范围 0-100",
        "【扩展性】targetType 支持 agency，为机构返点管理预留",
        "【业务规则】同一达人同一平台同一时间只有一条 active 记录"
    ],
    "examples": [
        {
            "description": "示例1：立即生效的返点调整",
            "data": {
                "configId": "rebate_config_1737024000000_abc123",
                "targetType": "talent",
                "targetId": "talent_00000005",
                "platform": "douyin",
                "rebateRate": 22.50,
                "effectType": "immediate",
                "effectiveDate": "2025-01-15T10:30:00.000Z",
                "expiryDate": null,
                "status": "active",
                "createdBy": "admin_user_id",
                "createdAt": "2025-01-15T10:30:00.000Z",
                "updatedAt": null
            }
        },
        {
            "description": "示例2：下次合作生效的返点调整（待生效）",
            "data": {
                "configId": "rebate_config_1737024000000_xyz789",
                "targetType": "talent",
                "targetId": "talent_00000005",
                "platform": "douyin",
                "rebateRate": 25.00,
                "effectType": "next_cooperation",
                "effectiveDate": "2025-02-01T00:00:00.000Z",
                "expiryDate": null,
                "status": "pending",
                "createdBy": "admin_user_id",
                "createdAt": "2025-01-15T10:30:00.000Z",
                "updatedAt": null
            }
        },
        {
            "description": "示例3：已失效的返点配置（被新配置替代，同一天内多次调整）",
            "data": {
                "configId": "rebate_config_1736928000000_def456",
                "targetType": "talent",
                "targetId": "talent_00000005",
                "platform": "douyin",
                "rebateRate": 20.00,
                "effectType": "immediate",
                "effectiveDate": "2025-01-15T08:00:00.000Z",
                "expiryDate": "2025-01-15T10:30:00.000Z",
                "status": "expired",
                "createdBy": "system",
                "createdAt": "2025-01-15T08:00:00.000Z",
                "updatedAt": "2025-01-15T10:30:00.000Z"
            }
        },
        {
            "description": "示例4：客户级返点配置（v2.2新增）",
            "data": {
                "configId": "rebate_config_1734168600000_cust01",
                "targetType": "customer_talent",
                "targetId": "CUS20250002_talent_00000005_xiaohongshu",
                "customerId": "CUS20250002",
                "talentOneId": "talent_00000005",
                "platform": "xiaohongshu",
                "rebateRate": 25.00,
                "previousRate": 20.00,
                "effectType": "immediate",
                "effectiveDate": "2025-12-14T10:30:00.000Z",
                "expiryDate": null,
                "status": "active",
                "reason": "客户谈判获得的专属返点",
                "createdBy": "user_002",
                "createdAt": "2025-12-14T10:30:00.000Z",
                "updatedAt": null
            }
        }
    ],
    "businessRules": [
        {
            "rule": "同一达人同一平台同一时间只能有一条 active 记录",
            "implementation": "创建新 active 配置时，先查找旧 active 记录，将其 status 改为 expired，expiryDate 设置为新配置的 effectiveDate，updatedAt 设置为当前时间"
        },
        {
            "rule": "expiryDate 自动管理",
            "implementation": "新配置创建时自动设置，表示配置的生命周期 [effectiveDate, expiryDate)，当前生效中的配置 expiryDate 为 null"
        },
        {
            "rule": "pending 记录在下次合作时自动激活",
            "implementation": "合作创建时检查是否有 pending 配置，有则激活并更新 currentRebate"
        },
        {
            "rule": "所有记录不可删除",
            "implementation": "不提供删除接口，只能通过 status 标记为 expired"
        },
        {
            "rule": "返点率精度为2位小数",
            "implementation": "API 层验证，数据库存储 Double 类型"
        }
    ],
    "migrations": [
        {
            "version": "v2.2",
            "date": "2025-12-14",
            "description": "支持客户级返点历史记录",
            "operations": [
                "targetType 枚举新增 'customer_talent'",
                "新增 customerId、talentOneId、previousRate 字段",
                "创建 idx_customer_talent_history 索引",
                "创建 idx_talent_all_customers 索引"
            ]
        },
        {
            "version": "v2.1",
            "date": "2025-11-15",
            "description": "创建 rebate_configs 集合",
            "operations": [
                "创建集合",
                "创建5个索引",
                "迁移现有达人的返点数据（可选）"
            ]
        }
    ]
}
